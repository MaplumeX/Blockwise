---
文档类型: 总任务文档
产品名称: Blockwise - 柳比歇夫时间管理 App
来源PRD: docs/PRD/PRD-v1.3.md
版本: v1.3
创建日期: 2026-01-22
最后更新: 2026-01-22
文档作者: Sisyphus
---

# Blockwise v1.3 总任务文档

## 整体目标

v1.3 聚焦解决“跨日 TimeEntry”的展示与统计一致性问题，并补齐创建/编辑体验：

- 允许单条 TimeEntry 跨越多个自然日（仍保持单条存储）。
- 在任一自然日视图中，只要 TimeEntry 与该日存在时间重叠，就必须展示该日的 Day Slice（按日展示切片）。
- 统计与导出筛选统一改为按“与时间段重叠的分钟数”计算，避免跨日条目漏算/漏导。
- 时间滚轮新增日期列，且严格限制为“今天及以前”；任何自动跨日推断也不得产生未来日期。

## 范围与约束

- **范围（本期必须交付）**
  - 跨日条目按 Day Slice 展示：时间线视图（Timeline View）+ 时间块视图（Time Block View）（PRD 2.1~2.2）。
  - 取消单条记录时长上限（不再限制 24 小时）（PRD 3.1）。
  - 创建/编辑时间滚轮新增“日期”列（日期 → 时 → 分），并实现跨日自动推断与严格校验（PRD 3.2~3.2.1）。
  - 统计口径按重叠分钟计算：按日趋势、按小时分布、分类统计（PRD 4.1~4.4）。
  - 导出按日期筛选时，按“与日期区间重叠”筛选（PRD 5.2）。

- **关键约束（必须遵守）**
  - Day Slice 仅用于展示与统计归因，不改变 TimeEntry 存储结构（PRD 1.2、7）。
  - 自然日边界以设备系统时区为准；当日范围为 `[D 00:00:00, D+1 00:00:00)`（PRD 1.3）。
  - 时间滚轮日期列：仅允许选择“今天”及以前日期；不支持循环滚动；“今天”为最后一个选项；不得出现未来日期（PRD 3.2.1、6.5）。
  - 自动跨日推断仅在“不产生未来日期”的前提下成立：若推断会落到未来，则视为无效输入并禁止保存（PRD 3.2、3.2.1、6.5）。

- **非目标（v1.3 不做或不承诺）**
  - 不将跨日条目物理拆分为多条 TimeEntry（PRD 7）。
  - 不新增“自动拆分跨日条目”的默认行为（除 PRD 3.2/3.2.1 定义的结束时间自动跨日推断）（PRD 7）。
  - 不引入复杂的跨日可视化编辑（例如在编辑页对每一天分别调整切片）（PRD 7）。

## 里程碑规划

> 里程碑按“可独立交付/可验收”切分；每个里程碑包含目标、范围/交付物、验收标准、依赖/风险与粗略工作量。

**里程碑依赖关系（建议顺序）**

- M1 定义并落地 Day Slice 展示规则，是 M3 统计/导出口径一致性的共同基础（PRD 1.2~1.3、4.2）。
- M2 的“日期列仅今天及以前 + 自动跨日不产生未来日期”规则，需要与 M1 的自然日边界保持一致，避免创建后在展示/统计侧出现口径不一致（PRD 1.3、3.2.1、6.5）。
- M3 可与 M1/M2 部分并行开发，但最终验收应在 M1/M2 行为稳定后收口（PRD 6.1~6.5）。

### M1: 跨日 Day Slice 展示（Timeline + Time Block）

- **目标**
  - 在时间线视图与时间块视图中，实现跨日 TimeEntry 在每个自然日的 Day Slice 展示，并保证排序、时间范围展示与编辑入口行为一致（PRD 2.1~2.2）。

- **范围 / 关键交付物**
  - 按日计算 Day Slice：`sliceStart = max(entry.startTime, D 00:00:00)`、`sliceEnd = min(entry.endTime, D+1 00:00:00)`，仅当 `sliceEnd > sliceStart` 才展示（PRD 1.2）。
  - 时间线视图（按日列表）
    - 展示所有与日期 `D` 重叠的 TimeEntry，并以 Day Slice 形式渲染（PRD 2.1.1）。
    - 条目排序按 `sliceStart` 正序；与现有“未追踪时间段”计算保持一致（PRD 2.1.1）。
    - 时间范围展示为分钟级 `HH:mm`；当 sliceEnd 为自然日边界 `D+1 00:00:00` 时，允许展示 `24:00`（仅展示层，不影响数据）（PRD 2.1.2）。
    - 对跨日 TimeEntry 在 Day Slice 卡片/行项目上展示轻量跨日标识，且能查看实际 start/end（包含日期与时间）（PRD 2.1.3）。
    - 点击 Day Slice 打开详情/编辑时，编辑对象必须为原始 TimeEntry，编辑页展示完整起止范围（PRD 2.1.4）。
  - 时间块视图（按日网格）
    - 渲染所有与日期 `D` 重叠的 TimeEntry 的 Day Slice（PRD 2.2.1）。
    - 延续跨小时切片展示，并保持视觉连续；跨日标识在任一小时切片上展示一次即可（避免重复）（PRD 2.2.2）。

- **验收标准（与 PRD 章节强绑定）**
  - 满足 PRD 6.1：`2026-01-01 23:00` 到 `2026-01-02 01:00` 在两天的时间线/时间块均可见对应 Day Slice，且 `2026-01-01` 展示 `23:00 - 24:00`、`2026-01-02` 展示 `00:00 - 01:00`。
  - 满足 PRD 6.2：`2026-01-01 10:00` 到 `2026-01-03 12:00` 在三天分别展示 `10:00-24:00`、`00:00-24:00`、`00:00-12:00`。
  - 满足 PRD 2.1.4（并以 PRD 6.1/6.2 场景抽检）：从任一 Day Slice 进入编辑，编辑页展示的是原始 TimeEntry 的完整 start/end（非切片）。

- **依赖与风险**
  - 依赖：以系统时区定义自然日边界（PRD 1.3）；需要能按“与某日窗口重叠”获取 TimeEntry（可通过查询或应用层过滤实现）。
  - 与其他里程碑：建议在 M1 同步沉淀“Day Slice 计算 + 自然日边界”一致性约定，供 M3 统计/导出复用，避免口径漂移（PRD 1.2~1.3、4.2、5.2）。
  - 风险：
    - `24:00` 仅展示层存在，容易与真实时间序列混淆；需确保不写回数据（PRD 2.1.2）。
    - Day Slice 排序与“未追踪时间段”逻辑耦合，容易出现边界缺口（PRD 2.1.1）。

- **粗略工作量**
  - 4~6 人日（含 UI 渲染、排序/间隔逻辑回归、跨日标识与点击编辑链路验证）。

### M2: 时间编辑升级（取消时长上限 + 日期滚轮 + 跨日推断约束）

- **目标**
  - 在时间线 Bottom Sheet 的创建/编辑流程中，支持“日期 → 时 → 分”三列滚轮选择起始/结束时间，并取消时长上限；同时严格禁止任何未来日期的选择与自动推断（PRD 3.1~3.2.1）。

- **范围 / 关键交付物**
  - 取消“单次记录时长 <= 24 小时”的限制，仅保留：结束时间点必须严格晚于开始时间点（PRD 3.1）。
  - 时间滚轮新增日期列（PRD 3.2.1）
    - 起始与结束时间选择控件均为三列：日期 → 时 → 分；日期列位于“时”列左侧。
    - 日期列步进 1 天；不循环；范围仅“今天”及以前；“今天”为最后一个选项。
    - 创建模式默认值：起始日期跟随当前选中日期（若选中日期晚于今天，则默认=今天）；结束日期默认等于起始日期（PRD 3.2.1）。
    - 编辑模式默认值：起始/结束日期分别预填条目的实际开始/结束日期（但不得晚于今天）（PRD 3.2.1）。
  - 跨日自动推断（PRD 3.2、3.2.1）
    - 当结束日期=起始日期且用户将结束时间调至 ≤ 起始时间时：优先将结束日期自动调整为起始日期的次日，并即时刷新 UI 与时长。
    - 若“次日”会晚于今天（将产生未来日期），则不自动调整并视为无效输入。
  - 校验与错误提示（PRD 3.2.1）
    - 任意时刻，若结束时间点不严格晚于开始时间点：底部主按钮置灰，并提供明确错误提示。

- **验收标准（与 PRD 章节强绑定）**
  - 满足 PRD 6.3：系统允许保存时长 > 24 小时的 TimeEntry，且创建/编辑阶段不再出现“单次记录时长不能超过 X 小时”类限制。
  - 满足 PRD 6.5：起始/结束时间滚轮均包含“日期 → 时 → 分”，且日期列仅显示“今天及以前”，并且“今天”为最后一个选项；滚轮向未来方向不应出现 `2026-01-23` 等未来日期。
  - 满足 PRD 6.5（未来日期防线）：当起始日期已为“今天”，在不手动调整结束日期的情况下将结束时间调至 ≤ 起始时间，系统不得自动把结束日期推到“明天”，应提示无效并置灰保存/创建按钮。
  - 满足 PRD 6.5（自动跨日推断）：开始 `2026-01-01 23:00`，仅将结束时间调为 `01:00`（结束日期未手动调整）时，系统自动将结束日期调整为 `2026-01-02` 并允许保存，时长展示 120 分钟。

- **依赖与风险**
  - 依赖：需要与当前日期选择/创建入口状态对齐（创建模式“选中日期晚于今天则默认今天”）（PRD 3.2.1）。
  - 与其他里程碑：M2 生成的 start/end 时间点（含跨日推断）必须与 M1 展示与 M3 重叠计算使用同一“自然日边界/系统时区”约定，确保创建→展示→统计链路一致（PRD 1.3、3.2.1、6.5）。
  - 风险：
    - 日期列不循环且“今天在底部”的交互与现有滚轮习惯可能不同，需避免误导用户（PRD 3.2.1、6.5）。
    - 自动跨日推断与校验逻辑边界复杂，容易出现“按钮可点但保存失败”或“状态不同步”（PRD 3.2.1）。

- **粗略工作量**
  - 4~7 人日（含滚轮 UI、默认值/预填、校验与错误提示、跨日推断与“禁止未来”边界回归）。

### M3: 统计与导出一致性（按重叠分钟 + 导出按重叠筛选）

- **目标**
  - 将统计口径与导出按日期筛选统一改为“与时间段重叠的分钟数”，并确保跨日条目按天/按小时正确拆分归因（PRD 4.1~4.4、5.2）。

- **范围 / 关键交付物**
  - 统计口径更新（PRD 4.1）
    - 在任意统计窗口 `[startTime, endTime)` 内，每条 TimeEntry 的贡献分钟数=与窗口的重叠分钟数 `overlapMinutes(entry, window)`。
  - 按日趋势（Daily Trends）（PRD 4.2）
    - 对于任意日期 `D`，该日分钟数=所有与 `D` 重叠的 TimeEntry 在 `D` 的 Day Slice 分钟和。
  - 按小时分布（Hourly Distribution）（PRD 4.3）
    - 以每小时桶 `[H:00, H+1:00)` 做重叠计算；跨日/跨小时条目必须拆分。
  - 分类统计（活动类型/标签）（PRD 4.4）
    - 统计区间内按活动类型/标签累加重叠分钟数，跨日条目同样按重叠计入。
  - 导出按日期筛选（PRD 5.2）
    - 导出格式保持原始 TimeEntry（startTime/endTime 不变）。
    - 当导出按日期范围筛选时，筛选规则按“与日期区间重叠”而非仅 startTime 归属，避免跨日条目漏导。

- **验收标准（与 PRD 章节强绑定）**
  - 满足 PRD 6.4：
    - 跨日条目在日趋势中两天分钟数之和=该条目总分钟数。
    - 小时分布按小时桶拆分归因（示例 23:30-00:30 在 23 点桶 30 分钟、0 点桶 30 分钟），不允许全部归到 startTime 所在小时。
  - 满足 PRD 5.2（并以 PRD 6.1/6.2 场景回归）：按日期筛选导出时，跨日条目只要与筛选区间有重叠就必须被导出，不得因 startTime 不在区间而漏导。

- **依赖与风险**
  - 依赖：需要复用并严格对齐 M1 的 Day Slice/自然日边界定义（PRD 1.2~1.3、4.2），同时确保与 M2 生成的 start/end 时间点语义一致（PRD 3.2~3.2.1）。
  - 风险：
    - 重叠计算引入更多边界场景（恰好落在边界、跨多日、长时长 >24h），若实现不一致会导致统计与列表显示“对不上”（PRD 4.1~4.4）。
    - 导出筛选口径变化可能影响用户预期（以往按 startTime 归属），需确保与 PRD 明确一致并提供可验证的行为（PRD 5.2）。

- **粗略工作量**
  - 3~6 人日（含重叠计算落地、各统计视图口径回归、导出筛选规则更新与跨日样例验证）。
