---
文档类型: 产品需求文档 (PRD)
产品名称: Blockwise - 柳比歇夫时间管理 App
版本: v1.3.1
创建日期: 2026-01-23
最后更新: 2026-01-23
文档作者: Product Team
审核状态: 待审核
---

# Blockwise v1.3.1 版本功能需求

## 概述

v1.3.1 在 v1.3 的基础上补齐一条关键数据约束：**禁止时间条目（TimeEntry）之间发生时间重叠**。

该约束的目标是让时间线/时间块的时间占用更符合直觉，避免统计口径在“同一分钟被多条记录重复占用”时出现不可解释的结果。

**主要更新**：
1. 创建/编辑等写入流程中，系统必须校验并阻止产生新的重叠 TimeEntry
2. 在编辑过程中提供明确的冲突提示，并展示冲突条目列表以便定位与修复
3. 对“今日之前”且无任何时间记录的日期，以 `00:00 - 24:00` 的未追踪时间段提示替代空状态

---

## 1. 时间条目禁止重叠（v1.3.1 新增）

### 1.1 目标

- **强约束**：用户通过 App 的创建/编辑流程写入的 TimeEntry，不允许与任何其它 TimeEntry 发生时间重叠。
- **可修复**：当用户输入导致重叠时，系统应即时反馈冲突原因，并提供足够信息帮助用户调整时间范围。

### 1.2 重叠定义与边界

- **时间区间语义**：每条 TimeEntry 的有效时间区间为 `[startTime, endTime)`（左闭右开）。
- **重叠（Overlap）**：两条 TimeEntry 存在重叠，当且仅当它们的交集时长 **大于 0**。
  - 等价判断：`max(a.startTime, b.startTime) < min(a.endTime, b.endTime)`。
- **相邻（Adjacent）不算重叠**：`a.endTime == b.startTime` 视为合法（两条记录在边界处衔接）。
- **精度**：以数据层保存的时间戳精度为准（例如秒级）。UI 展示为分钟级不影响重叠判断。

### 1.3 校验范围与触发时机

- **触发时机**：在以下所有会“新增或修改 TimeEntry 时间范围”的流程中，系统必须执行重叠校验：
  - 时间线 Bottom Sheet 创建
  - 时间线 Bottom Sheet 编辑（修改起止时间）
  - 时间块视图范围创建（若支持）
  - 合并/拆分等会生成新时间范围的操作（若支持）

- **校验范围**：对当前待保存的 TimeEntry（编辑模式需排除自身）与数据源中所有其它 TimeEntry 做重叠检查。

- **判定时点**：以最终将要写入的数据为准（包含跨日自动推断后的最终 start/end）。

### 1.4 交互与提示

- 当用户的输入导致与现有条目重叠时：
  - 底部主按钮（创建/保存/修改）置灰不可点
  - 在时间选择区域给出明确错误提示（例如：`与已有时间条目冲突，请调整时间范围`）
  - 展示冲突条目列表，至少包含：活动类型、时间范围（含日期/时间）、条目数量
  - 点击冲突条目可进入其详情/编辑入口，便于用户快速消除冲突

### 1.5 与跨日 / Day Slice 的关系

- **跨日条目仍允许存在**（延续 v1.3）：单条 TimeEntry 可以跨越多个自然日。
- 重叠判断基于 TimeEntry 的实际时间区间（绝对时间），不基于 Day Slice。

### 1.6 兼容性与存量数据

- v1.3.1 的核心约束是：通过 App 的创建/编辑等交互写入，不应产生新的重叠。
- 若由于历史数据、导入或异常导致数据源中已存在重叠：
  - 不要求本版本自动修复或自动消除重叠
  - 仍应提供可定位的冲突提示/冲突列表，帮助用户通过编辑手动消除重叠

---

## 2. 历史日期空记录显示为未追踪时间段（v1.3.1 新增）

### 2.1 规则

- 适用范围：当用户在时间线视图查看日期 `D`，且 `D` 严格早于“今天”（以设备系统时区定义的自然日为准）。
- 若日期 `D` 下不存在任何 TimeEntry（即：与 `[D 00:00:00, D+1 00:00:00)` 有重叠的条目数量为 0）：
  - 系统不应显示“无时间记录”类空状态
  - 系统应显示 1 条“未追踪时间段”提示，范围为 `00:00 - 24:00`
  - 该提示应复用现有“未追踪时间段”交互：点击后进入创建流程，并将起止时间预填为 `D 00:00` 到 `D+1 00:00`（展示层可显示为 `00:00 - 24:00`）

### 2.2 边界与说明

- 若日期 `D` 下存在至少 1 条 TimeEntry：仍按既有规则展示条目与其间的“未追踪时间段”（不额外插入全日提示）。
- 对于“今天”：本需求不强制替换空状态（可保留“今天还没有记录”等引导型空态）。

---

## 3. 成功标准（验收）

### 3.1 相邻条目允许保存

- 已存在 TimeEntry A：`2026-01-01 09:00` - `2026-01-01 10:00`
- 创建 TimeEntry B：`2026-01-01 10:00` - `2026-01-01 11:00`
  - 系统允许保存成功

### 3.2 重叠条目禁止保存（同日）

- 已存在 TimeEntry A：`2026-01-01 09:00` - `2026-01-01 10:00`
- 创建/编辑 TimeEntry B：`2026-01-01 09:30` - `2026-01-01 10:30`
  - 系统禁止保存/创建
  - 底部主按钮置灰
  - 显示冲突提示，并能在冲突列表中定位到 TimeEntry A

### 3.3 重叠条目禁止保存（跨日）

- 已存在 TimeEntry A：`2026-01-01 23:00` - `2026-01-02 01:00`
- 创建/编辑 TimeEntry B：`2026-01-02 00:30` - `2026-01-02 02:00`
  - 系统禁止保存/创建，并能定位冲突条目

### 3.4 跨日自动推断后仍需满足不重叠

- 已存在 TimeEntry A：`2026-01-02 00:30` - `2026-01-02 01:30`
- 创建模式：开始 `2026-01-01 23:00`，结束时间仅调整为 `01:00`（结束日期未手动调整，触发跨日自动推断）
  - 系统将结束日期推断为 `2026-01-02`
  - 若推断后的区间与 A 重叠，则系统必须禁止保存并提示冲突

### 3.5 历史日期空记录显示为全日未追踪段

- 假设系统今天为 `2026-01-22`，用户查看日期 `2026-01-20`，且该日没有任何 TimeEntry 与之重叠：
  - 系统展示 1 条未追踪时间段提示：`00:00 - 24:00`
  - 点击该提示进入创建流程，默认预填起止范围为 `2026-01-20 00:00` - `2026-01-21 00:00`

---

## 4. 非目标（本版本不做）

- 不在 v1.3.1 内引入“自动修复重叠”的策略（例如自动裁剪、自动拆分、自动吸附到相邻边界）。
- 不在 v1.3.1 内强制对历史数据做迁移或批量消除重叠（若存在历史/导入导致的重叠，优先通过编辑引导用户修复）。
