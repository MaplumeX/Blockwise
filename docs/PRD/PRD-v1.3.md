---
文档类型: 产品需求文档 (PRD)
产品名称: Blockwise - 柳比歇夫时间管理 App
版本: v1.3
创建日期: 2026-01-22
最后更新: 2026-01-22
文档作者: Product Team
审核状态: 已审核
---

# Blockwise v1.3 版本功能需求

## 概述

v1.3 聚焦解决「跨日时间条目」在时间线/时间块视图中的显示一致性问题，并取消单条记录的时长上限。

**核心目标**：一条 TimeEntry 允许跨越多个自然日；在任一自然日的视图中，只要该条目与该自然日存在时间重叠，就必须在该自然日展示对应的“当日切片”（虚拟展示段）。

**主要更新**：
1. 支持跨日条目在各自然日视图中切片展示（时间线视图 + 时间块视图）
2. 取消单次记录时长限制（不再限制 24 小时）
3. 更新时间编辑能力：时间滚轮支持选择日期（日期列位于“时”列左侧）
4. 更新统计口径：按“与时间段重叠”计算，跨日条目按天/按小时拆分归因

---

## 1. 术语与定义

### 1.1 TimeEntry（时间条目）

- TimeEntry 为用户创建/编辑/导入的一条时间记录，包含：活动类型、起始时间、结束时间、备注、标签等。
- TimeEntry 在数据层为“单条记录”，允许跨日。

### 1.2 Day Slice（按日展示切片）

为保证跨日条目在“各天都能显示”，在 UI 层引入“按日展示切片（Day Slice）”概念：

- Day Slice 是 TimeEntry 在某个自然日 `D` 下的展示片段
- 计算方式：
  - `sliceStart = max(entry.startTime, D 00:00:00)`
  - `sliceEnd = min(entry.endTime, D+1 00:00:00)`
  - 当 `sliceEnd <= sliceStart` 时，该自然日不展示该条目
- Day Slice 只用于展示与当日统计归因，不改变 TimeEntry 的存储结构。

### 1.3 自然日边界

- 自然日边界以用户设备当前时区（system timezone）为准。
- 当日范围为 `[D 00:00:00, D+1 00:00:00)`。

---

## 2. 跨日条目展示（v1.3 新增）

### 2.1 时间线视图（Timeline View）按日列表展示

#### 2.1.1 展示规则

- 在查看某一日期 `D` 的时间线时，系统必须展示所有与日期 `D` 存在重叠的 TimeEntry（基于 Day Slice 计算）。
- 跨日 TimeEntry 必须在其覆盖的每一天都展示对应的 Day Slice。
- 每个自然日分组内条目排序按 `sliceStart` 正序（与“当天时间轴”一致），并保持与现有“未追踪时间段”计算一致。

#### 2.1.2 时间范围展示（分钟级）

- 时间线列表仍保持分钟级展示（`HH:mm`），秒级信息不在列表中展示。
- 当 Day Slice 的结束点为“自然日边界”（即 `D+1 00:00:00`）时，允许在展示字符串中使用 `24:00` 表示当日结束边界（仅展示层使用，不影响数据）。
  - 示例：`23:00 - 24:00`（表示从当日 23:00 到当日结束）

#### 2.1.3 跨日标识

- 对于跨日 TimeEntry（即 startTime 与 endTime 不在同一自然日），在 Day Slice 的卡片/行项目上显示明确标识（标明实际的开始和结束时间（日和时间)）。
- 标识不应增加列表阅读负担，优先采用轻量样式。

#### 2.1.4 点击与编辑行为

- 用户点击某一天的 Day Slice，打开详情/编辑入口时：
  - 编辑对象必须是原始 TimeEntry（而不是 Day Slice）
  - 编辑页需展示完整的起止时间范围（包含跨日信息）

> 说明：Day Slice 是展示概念，任何增删改操作都作用于原始 TimeEntry。

### 2.2 时间块视图（Time Block View）按日网格展示

#### 2.2.1 展示规则

- 在查看某一日期 `D` 的时间块视图时，系统必须渲染所有与日期 `D` 重叠的 TimeEntry 的 Day Slice。
- 跨日条目在时间块视图中天然以“当日部分”展示；其余部分在其他日期下展示。

#### 2.2.2 跨小时切片

- 延续现有规则：同一条记录跨越多个小时，按小时行切片显示，但视觉上保持连续（同色/对齐/端点一致）。
- 当记录跨日时，跨日切片的“跨日”标识可在任一小时切片上展示一次即可（避免重复）。

---

## 3. 取消单次记录时长限制（v1.3 修改）

### 3.1 规则调整

- 系统不再对单条 TimeEntry 的时长设置上限（例如不再限制 24 小时）。
- 保留最基本有效性约束：结束时间必须严格晚于开始时间。

### 3.2 创建/编辑交互

- 当用户仅选择“日期 + 起始时间 + 结束时间”且结束时间早于起始时间时，系统应默认理解为跨日到“次日同一结束时间”（前提：次日不晚于今天；若将产生未来日期则视为无效输入）。
- 若用户希望创建跨越超过 1 天的条目，系统应提供“结束日期”选择能力（通过时间滚轮的“日期”列实现，详见 3.2.1）。

#### 3.2.1 时间滚轮支持选择日期（新增）

- 在时间线 Bottom Sheet 的起始/结束时间选择控件中，为现有“时/分”双滚轮新增“日期”滚轮，放置在“时”列左侧（列顺序：日期 → 时 → 分）。
- 起始与结束时间均可独立选择日期与时间；系统将据此计算起止时间点与时长，并在滚轮变化时即时刷新。
- 日期滚轮步进为 1 天；“时”滚轮范围为 00–23；“分”滚轮范围为 00–59；分钟步进保持为 1 分钟。
- 日期滚轮范围：仅允许选择“今天”及以前的日期；日期列不支持循环滚动。“今天”为日期列最后一个选项（滚轮滚到底）。
- 默认值：
  - 创建模式：起始日期默认跟随当前选中日期（但不得晚于今天；若选中日期晚于今天，则起始日期默认=今天）；结束日期默认等于起始日期。
  - 编辑模式：起始/结束日期分别预填为条目的实际开始/结束日期（但不得晚于今天）。
- 跨日自动推断规则需与日期滚轮一致：当结束日期=起始日期且用户将结束时间调至 ≤ 起始时间时，系统应优先将结束日期调整为起始日期的次日，并同步更新 UI 展示与时长；若该次日会晚于今天（即将产生未来日期），则不自动调整并视为无效输入。
- 校验：结束时间点必须严格晚于开始时间点；不满足时底部主按钮置灰，并给出明确错误提示。

---

## 4. 统计口径更新（v1.3 修改）

### 4.1 统计的基本原则

为与“跨日条目在各天都能显示”保持一致，统计必须基于“与统计时间段重叠”的分钟数计算，而不能仅按 startTime 归属。

- **统计窗口**：任意统计区间 `[startTime, endTime)`
- **计入规则**：每条 TimeEntry 贡献的分钟数 = `overlapMinutes(entry, window)`

### 4.2 按日趋势（Daily Trends）

- 对于任意日期 `D`，该日总分钟数必须等于所有与 `D` 重叠的 TimeEntry 在 `D` 的 Day Slice 的分钟和。
- 跨日条目必须按 Day Slice 进行拆分归因。

### 4.3 按小时分布（Hourly Distribution）

- 小时分布必须按“每小时桶”进行重叠计算：
  - 例如 23:30-00:30，应在 23 点桶计入 30 分钟，在 0 点桶计入 30 分钟。

### 4.4 分类统计（活动类型/标签）

- 统计区间内的活动类型/标签分钟数必须基于与区间的重叠分钟数累加。
- 跨日条目在区间内的贡献同样按重叠分钟数计入。

---

## 5. 兼容性与一致性要求

### 5.1 历史数据兼容

- 对已有数据无需迁移；只要 TimeEntry 存在跨日（start/end 不同自然日），v1.3 即可按 Day Slice 在各天展示。

### 5.2 与导入/导出

- 导出数据的原始 TimeEntry 结构保持不变（仍导出单条记录的 startTime/endTime）。
- 当导出按日期筛选时，筛选规则必须基于“与日期区间重叠”而非仅 startTime 归属（避免跨日条目漏导）。

---

## 6. 验收标准（v1.3）

### 6.1 跨日显示验收

- 创建一条 TimeEntry：`2026-01-01 23:00` 到 `2026-01-02 01:00`
  - 在 `2026-01-01` 时间线/时间块视图中可见该条目的 Day Slice，范围显示为 `23:00 - 24:00`，时长 60 分钟
  - 在 `2026-01-02` 时间线/时间块视图中可见该条目的 Day Slice，范围显示为 `00:00 - 01:00`，时长 60 分钟

### 6.2 多日跨度验收

- 创建一条 TimeEntry：`2026-01-01 10:00` 到 `2026-01-03 12:00`
  - `2026-01-01` 显示 `10:00 - 24:00`
  - `2026-01-02` 显示 `00:00 - 24:00`
  - `2026-01-03` 显示 `00:00 - 12:00`

### 6.3 取消时长限制验收

- 系统允许保存时长 > 24 小时的 TimeEntry
- 不因时长过长在创建/编辑阶段提示“单次记录时长不能超过 X 小时”

### 6.4 统计口径验收

- 对于跨日条目，日趋势中两天的分钟数之和必须等于该条目总分钟数
- 对于跨日条目，小时分布必须按小时桶拆分归因（不允许把全部分钟归到 startTime 所在小时）

### 6.5 时间滚轮日期选择验收（新增）

- 在时间线 Bottom Sheet 创建/编辑模式下，起始与结束时间选择控件均包含“日期 → 时 → 分”三列滚轮，且日期列位于“时”列左侧。
- 假设系统今天为 `2026-01-22`：日期列最后一个选项显示为“今天”，滚轮滚到底后继续向未来方向滚动不应出现 `2026-01-23` 等未来日期。
- 假设起始日期已为“今天”：在不手动调整结束日期的情况下，将结束时间调至 ≤ 起始时间
  - 系统不应自动把结束日期推到“明天”；应提示无效并置灰保存/创建按钮
- 创建一条 TimeEntry：开始 `2026-01-01 23:00`，仅将结束时间调为 `01:00`（结束日期未手动调整）
  - 系统自动将结束日期调整为 `2026-01-02`，并允许保存
  - 时长展示为 120 分钟
- 创建一条 TimeEntry：开始 `2026-01-01 10:00`，结束 `2026-01-03 12:00`
  - 可通过结束日期滚轮选择到 `2026-01-03` 并保存成功
  - 保存后在 `2026-01-02` 的视图中可见该条目的 Day Slice（与第 2 节规则一致）

---

## 7. 非目标（本版本不做）

- 不强制要求将跨日条目“物理拆分”为多条 TimeEntry（保持单条存储，UI/统计切片即可）
- 不新增“自动拆分跨日条目”的默认行为（除非后续版本单独定义）
- 不在本版本内引入复杂的跨日可视化编辑（例如在编辑页对每一天分别调整切片）
